% Copyright (c) 2024 Alexander Bluhm <bluhm@genua.de>
%
% Permission to use, copy, modify, and distribute this software for any
% purpose with or without fee is hereby granted, provided that the above
% copyright notice and this permission notice appear in all copies.
%
% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

\documentclass[14pt]{beamer}
\usetheme{Frankfurt}
\usepackage{tikz}
\usepackage{framed}
\usepackage{graphicx}
\usepackage{varwidth}
\usepackage{tipa}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{upquote}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usetikzlibrary{shapes.arrows}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{shapes.symbols}
\author{Alexander Bluhm}
\title{A Packet's Journey Through the OpenBSD Network Stack}
\institute{genua GmbH\\ \url{bluhm@genua.de}\\ \url{bluhm@openbsd.org}}
\date{September 2024}
\let\Tiny\tiny

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Agenda}
\setcounter{tocdepth}{1}
\tableofcontents
\end{frame}

\section{Networking}

\subsection{Environment}
\begin{frame}{Environment}
\begin{tikzpicture}
  \node [cloud, draw, aspect=2]
    at (-3.8, 0)
    {Network};
  \node [align=center, arrow box, draw,
    arrow box arrows={east:1cm, north:.5cm, west:1cm}]
    at (0, 0)
    {\begin{varwidth}{\textwidth}\centering OpenBSD \\ Kernel\end{varwidth}};
  \node [cloud, draw, aspect=2]
    at (3.8, 0)
    {Internet};
  \node [ellipse, draw, aspect=2]
    at (0, 1.8)
    {Application};
\end{tikzpicture}
\end{frame}

\section{Measurement}

\subsection{Protocol Statistics Counter}
\begin{frame}[fragile]{Protocol Statistics Counter}
netstat -ss
\scriptsize
\begin{verbatim}
ip:
    2208239 total packets received
    2204405 packets for this host
    3717 packets for unknown/unsupported protocol
    101 packets not forwardable
tcp:
    1542163 packets sent
        616615 data packets (165690394 bytes)
        333 data packets (296898 bytes) retransmitted
        740242 ack-only packets (646590 delayed)
        153288 window update packets
\end{verbatim}
\end{frame}

\subsection{pf States}
\begin{frame}[fragile]{pf State}
pfctl -ss
\scriptsize
\begin{verbatim}
em0 tcp 80.154.94.48:22 <- 84.191.39.187:60436
       ESTABLISHED:ESTABLISHED
em0 tcp 192.168.0.31:22 (80.154.94.48:10031) <- 80.154.94.10:19890
       ESTABLISHED:ESTABLISHED
em1 tcp 80.154.94.10:19890 -> 192.168.0.31:22
       ESTABLISHED:ESTABLISHED
em0 tcp 192.168.0.31:443 (80.154.94.48:443) <- 193.30.66.53:51727
       CLOSING:ESTABLISHED
\end{verbatim}
\end{frame}

\subsection{Network Sockets}
\begin{frame}[fragile]{Network Sockets}
netstat -an
\scriptsize
\begin{verbatim}
Active Internet connections (including servers)
Proto   Recv-Q Send-Q  Local Address   Foreign Address  TCP-State
tcp          0      0  10.0.1.37.22    10.0.1.2.30176   ESTABLISHED
tcp          0   1144  10.0.1.37.22    10.0.1.1.27069   ESTABLISHED
tcp          0     44  10.0.1.37.22    10.0.1.2.49002   ESTABLISHED
tcp          0      0  *.22            *.*              LISTEN
Active Internet connections (including servers)
Proto   Recv-Q Send-Q  Local Address   Foreign Address
udp          0      0  10.0.1.37.7040  10.0.1.1.123
udp          0      0  10.0.1.37.161   *.*
udp          0      0  *.*             *.*
\end{verbatim}
\end{frame}

\subsection{Tcpdump Traffic}
\begin{frame}[fragile]{Tcpdump Traffic}
tcpdump -ni enc0 -v
\scriptsize
\begin{verbatim}
18:45:13.665393 (unprotected): SPI 0x00006861:
  fdd7:e83e:66bc:100::17 > fdd7:e83e:66bc:100::70:
  10.188.168.17 > 10.188.175.72:
  icmp: echo request
  (id:c52b seq:0) (ttl 255, id 8945, len 1028) (len 1028, hlim 64)
18:45:13.665849 (unprotected): SPI 0x00006862:
  fdd7:e83e:66bc:100::70 > fdd7:e83e:66bc:100::17:
  10.188.175.72 > 10.188.168.17:
  icmp: echo reply
  (id:c52b seq:0) (ttl 253, id 7503, len 1028) (len 1028, hlim 64)
\end{verbatim}
\end{frame}

\section{Implementation}

\subsection{Layer}
\begin{frame}{Layer}
\begin{tikzpicture}
  \draw (-1,0) rectangle +(6,1) node(l1) [midway] {Physical};
  \draw (-1,1) rectangle +(6,1) node(l1) [midway] {Driver};
  \draw (-1,2) rectangle +(6,1) node(l2) [midway] {Ethernet};
  \draw (-1,3) rectangle +(6,1) node(l3) [midway] {Network IP};
  \draw (-1,4) rectangle +(6,1) node(l4) [midway] {TCP/UDP/Raw};
  \draw (-1,5) rectangle +(6,1) node(l5) [midway] {Socket};
  \draw (-1,6) rectangle +(6,1) node(l5) [midway] {Application};
  \draw[thick] (-4,5.5) node(context) {} -- +(5,0) +(7,0) -- +(10.5,0);
  \node [below right] at (context) {Kernel};
  \node [above right] at (context) {User Land};
  \draw[thick] (-4,1) node(hardware) {} -- +(10.5,0);
  \node [below right] at (hardware) {Hardware};
\end{tikzpicture}
\end{frame}

\subsection{Input Queues}
\begin{frame}{Input Queues}
\begin{framed}
\begin{tikzpicture}
  \draw (0,0)
    node (ni) [right] {network interface} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) ++(0,-.2)
    node (rx) [right] {receive DMA ring} ++(-.5-1*.4,.8)
    node (dd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iq) [right] {interface input queue} ++(-.5,.8)
    node (is) [right] {IP stack} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (rb) [right] {socket receive buffer} ++(-.5,.8)
    node (so) [right] {socket};
  \path (node cs:name=ni,anchor=west) +(.3+1*.4,.3) coordinate (nio) {};
  \path (node cs:name=rx,anchor=west) +(-.2-3*.4,0) coordinate (rxi) {};
  \draw[->] (nio) -- (rxi);
  \path (node cs:name=rx,anchor=west) +(-.2-1*.4,0) coordinate (rxo) {};
  \path (node cs:name=dd,anchor=west) +(.3,-.3) coordinate (ddi) {};
  \draw[->] (rxo) -- (ddi);
  \path (node cs:name=dd,anchor=west) +(.3+1*.4,.3) coordinate (ddo) {};
  \path (node cs:name=iq,anchor=west) +(-.2-2*.4,0) coordinate (iqi) {};
  \draw[->] (ddo) -- (iqi);
  \path (node cs:name=iq,anchor=west) +(-.2,0) coordinate (iqo) {};
  \path (node cs:name=is,anchor=west) +(.3,-.3) coordinate (isi) {};
  \draw[->] (iqo) -- (isi);
  \path (node cs:name=is,anchor=west) +(.3+1*.4,.3) coordinate (iso) {};
  \path (node cs:name=rb,anchor=west) +(-.2-2*.4,0) coordinate (rbi) {};
  \draw[->] (iso) -- (rbi);
  \path (node cs:name=rb,anchor=west) +(-.2,0) coordinate (rbo) {};
  \path (node cs:name=so,anchor=west) +(.3,-.3) coordinate (soi) {};
  \draw[->] (rbo) -- (soi);
\end{tikzpicture}
\end{framed}
\end{frame}

\subsection{Output Queues}
\begin{frame}{Output Queues}
\begin{framed}
\begin{tikzpicture}
  \draw (0,0)
    node (so) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (sb) [right] {socket send buffer} ++(-.5,-.8)
    node (is) [right] {IP stack} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (oq) [right] {interface output queue} ++(-.5,-.8)
    node (dd) [right] {device driver} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) ++(0,.2)
    node (tx) [right] {transmit DMA ring} ++(-.5-1*.4,-.8)
    node (ni) [right] {network interface};
  \path (node cs:name=so,anchor=west) +(.3+1*.4,-.3) coordinate (soo) {};
  \path (node cs:name=sb,anchor=west) +(-.2-2*.4,0) coordinate (sbi) {};
  \draw[->] (soo) -- (sbi);
  \path (node cs:name=sb,anchor=west) +(-.2,0) coordinate (sbo) {};
  \path (node cs:name=is,anchor=west) +(.3,.3) coordinate (isi) {};
  \draw[->] (sbo) -- (isi);
  \path (node cs:name=is,anchor=west) +(.3+1*.4,-.3) coordinate (iso) {};
  \path (node cs:name=oq,anchor=west) +(-.2-2*.4,0) coordinate (oqi) {};
  \draw[->] (iso) -- (oqi);
  \path (node cs:name=oq,anchor=west) +(-.2,0) coordinate (oqo) {};
  \path (node cs:name=dd,anchor=west) +(.3,.3) coordinate (ddi) {};
  \draw[->] (oqo) -- (ddi);
  \path (node cs:name=dd,anchor=west) +(.3+1*.4,-.3) coordinate (ddo) {};
  \path (node cs:name=tx,anchor=west) +(-.2-3*.4,0) coordinate (txi) {};
  \draw[->] (ddo) -- (txi);
  \path (node cs:name=tx,anchor=west) +(-.2-1*.4,0) coordinate (txo) {};
  \path (node cs:name=ni,anchor=west) +(.3,.3) coordinate (nii) {};
  \draw[->] (txo) -- (nii);
\end{tikzpicture}
\end{framed}
\end{frame}

\subsection{Socket Buffer Recv-Q Send-Q}
\begin{frame}[fragile]{Socket Buffer Recv-Q Send-Q}
\begin{framed}
\begin{tikzpicture}
  \draw (0,0)
    node (iis) [right] {IP stack} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (irb) [right] {receive buffer} ++(-.5,.8)
    node (iso) [right] {socket} ++(4.5,0)
    node (oso) [right] {socket} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (osb) [right] {send buffer} ++(-.5,-.8)
    node (ois) [right] {IP stack} ++(.1,-.6);
  \path (node cs:name=iis,anchor=west) +(.3+1*.4,.3) coordinate (iiso) {};
  \path (node cs:name=irb,anchor=west) +(-.2-2*.4,0) coordinate (irbi) {};
  \draw[->] (iiso) -- (irbi);
  \path (node cs:name=irb,anchor=west) +(-.2,0) coordinate (irbo) {};
  \path (node cs:name=iso,anchor=west) +(.3,-.3) coordinate (isoi) {};
  \draw[->] (irbo) -- (isoi);
  \path (node cs:name=oso,anchor=west) +(.3+1*.4,-.3) coordinate (osoo) {};
  \path (node cs:name=osb,anchor=west) +(-.2-2*.4,0) coordinate (osbi) {};
  \draw[->] (osoo) -- (osbi);
  \path (node cs:name=osb,anchor=west) +(-.2,0) coordinate (osbo) {};
  \path (node cs:name=ois,anchor=west) +(.3,.3) coordinate (oisi) {};
  \draw[->] (osbo) -- (oisi);
\end{tikzpicture}
\end{framed}
netstat -n -p tcp
\scriptsize
\begin{verbatim}
Active Internet connections (including servers)
Proto  Recv-Q Send-Q  Local Address     Foreign Address   TCP-State
tcp     65160      0  10.10.11.2.35477  10.10.11.1.41996  ESTABLISHED
tcp         0 131732  10.10.12.3.44648  10.10.12.4.12345  ESTABLISHED
\end{verbatim}
\end{frame}

\subsection{Interface Queue qdrops}
\begin{frame}[fragile]{Interface Queue qdrops}
\begin{framed}
\begin{tikzpicture}
  \draw (0,0)
    node (idd) [right] {device driver} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (iiq) [right] {input queue} ++(-.5,.8)
    node (iis) [right] {IP stack} ++(4,0)
    node (ois) [right] {IP stack} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4) ++(0,-.2)
    node (ooq) [right] {output queue} ++(-.5,-.8)
    node (odd) [right] {device driver};
  \path (node cs:name=idd,anchor=west) +(.3+1*.4,.3) coordinate (iddo) {};
  \path (node cs:name=iiq,anchor=west) +(-.2-2*.4,0) coordinate (iiqi) {};
  \draw[->] (iiso) -- (iiqi);
  \path (node cs:name=iiq,anchor=west) +(-.2,0) coordinate (iiqo) {};
  \path (node cs:name=iis,anchor=west) +(.3,-.3) coordinate (iisi) {};
  \draw[->] (iiqo) -- (iisi);
  \path (node cs:name=ois,anchor=west) +(.3+1*.4,-.3) coordinate (oiso) {};
  \path (node cs:name=ooq,anchor=west) +(-.2-2*.4,0) coordinate (ooqi) {};
  \draw[->] (oiso) -- (ooqi);
  \path (node cs:name=ooq,anchor=west) +(-.2,0) coordinate (ooqo) {};
  \path (node cs:name=odd,anchor=west) +(.3,.3) coordinate (oddi) {};
  \draw[->] (ooqo) -- (oddi);
\end{tikzpicture}
\end{framed}
kstat
\\
\vspace{.2cm}
\scriptsize
\begin{tabular}{ll}
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix0:0:rxq:0
	 packets: 158069114 packets
	   bytes: 300328302395 bytes
	  qdrops: 7902615 packets
	    qlen: 0 packets
	enqueues: 6947931
	dequeues: 5729695
  \end{verbatim}
  \end{minipage}
  &
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix0:0:txq:0
	 packets: 11094621 packets
	   bytes: 894601044 bytes
	  qdrops: 0 packets
	    qlen: 0 packets
	 maxqlen: 255 packets
  \end{verbatim}
  \end{minipage}
  \\
\end{tabular}
\end{frame}

\subsection{Device Driver OACTIVE}
\begin{frame}[fragile]{Device Driver OACTIVE}
\begin{framed}
\begin{tikzpicture}
  \draw (0,0)
    node (dd) [right] {device driver} ++(.1,-.6)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) rectangle ++(.4,.4)
    rectangle ++(.4,-.4) ++(0,.2)
    node (tx) [right] {transmit DMA ring} ++(-.5-1*.4,-.8)
    node (ni) [right] {network interface};
  \path (node cs:name=dd,anchor=west) +(.3+1*.4,-.3) coordinate (ddo) {};
  \path (node cs:name=tx,anchor=west) +(-.2-3*.4,0) coordinate (txi) {};
  \draw[->] (ddo) -- (txi);
  \path (node cs:name=tx,anchor=west) +(-.2-1*.4,0) coordinate (txo) {};
  \path (node cs:name=ni,anchor=west) +(.3,.3) coordinate (nii) {};
  \draw[->] (txo) -- (nii);
\end{tikzpicture}
\end{framed}
ifconfig em1
\scriptsize
\begin{verbatim}
em1: flags=8c43<UP,BROADCAST,RUNNING,OACTIVE,SIMPLEX,MULTICAST> mtu 1500
        lladdr 0c:c4:7a:78:f3:55
        description: Intel I210
        index 6 priority 0 llprio 3
        media: Ethernet autoselect (1000baseT full-duplex)
        status: active
        inet 10.10.12.3 netmask 0xffffff00 broadcast 10.10.12.255
\end{verbatim}
\end{frame}

\subsection{Transmit Rings oactives}
\begin{frame}[fragile]{Transmit Rings oactives}
dmesg
\scriptsize
\begin{verbatim}
ix1 at pci1 dev 0 function 1 "Intel X550T" rev 0x01, msix,
  4 queues, address a0:36:9f:e0:52:55
\end{verbatim}
\normalsize
kstat txq
\\
\vspace{.3cm}
\scriptsize
\begin{tabular}{ll}
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix1:0:txq:0
            qlen: 90 packets
         maxqlen: 255 packets
         oactive: true
        oactives: 1919595
  \end{verbatim}
  \end{minipage}
  &
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix1:0:txq:1
            qlen: 141 packets
         maxqlen: 255 packets
         oactive: true
        oactives: 2251633
  \end{verbatim}
  \end{minipage}
  \\
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix1:0:txq:2
            qlen: 6 packets
         maxqlen: 255 packets
         oactive: true
        oactives: 1788971
  \end{verbatim}
  \end{minipage}
  &
  \begin{minipage}{4.5cm}
  \begin{verbatim}
ix1:0:txq:3
            qlen: 55 packets
         maxqlen: 255 packets
         oactive: true
        oactives: 1925063
  \end{verbatim}
  \end{minipage}
  \\
\end{tabular}
\end{frame}



\section{Conclusion}

\subsection{Links}
\begin{frame}{Links}
\begin{itemize}
    \item these slides
	{\small \url{https://github.com/bluhm/talk-packetflow}}
\end{itemize}
\end{frame}

\subsection{Questions}
\begin{frame}{Questions}
\begin{center}
\begin{tikzpicture}
\draw [font=\Huge] node {?};
\end{tikzpicture}
\end{center}
\end{frame}

\end{document}
