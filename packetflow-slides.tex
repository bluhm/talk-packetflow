% Copyright (c) 2024 Alexander Bluhm <bluhm@genua.de>
%
% Permission to use, copy, modify, and distribute this software for any
% purpose with or without fee is hereby granted, provided that the above
% copyright notice and this permission notice appear in all copies.
%
% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

\documentclass[14pt]{beamer}
\usetheme{Frankfurt}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{varwidth}
\usepackage{tipa}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{upquote}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\usetikzlibrary{shapes.arrows}
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{shapes.symbols}
\author{Alexander Bluhm}
\title{A Packet's Journey Through the OpenBSD Network Stack}
\institute{genua GmbH\\ \url{bluhm@genua.de}\\ \url{bluhm@openbsd.org}}
\date{September 2024}
\let\Tiny\tiny

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Agenda}
\setcounter{tocdepth}{1}
\tableofcontents
\end{frame}

\section{Networking}

\subsection{Environment}
\begin{frame}{Environment}
\begin{tikzpicture}
  \node [cloud, draw, aspect=2]
    at (-3.8, 0)
    {Network};
  \node [align=center, arrow box, draw,
    arrow box arrows={east:1cm, north:.5cm, west:1cm}]
    at (0, 0)
    {\begin{varwidth}{\textwidth}\centering OpenBSD \\ Kernel\end{varwidth}};
  \node [cloud, draw, aspect=2]
    at (3.8, 0)
    {Internet};
  \node [ellipse, draw, aspect=2]
    at (0, 1.8)
    {Stack};
\end{tikzpicture}
\end{frame}

\section{Measurement}

\subsection{Counter}
\begin{frame}[fragile]{Counter}
netstat -ss
\scriptsize
\begin{verbatim}
ip:
    2208239 total packets received
    2204405 packets for this host
    3717 packets for unknown/unsupported protocol
    101 packets not forwardable
tcp:
    1542163 packets sent
	616615 data packets (165690394 bytes)
	333 data packets (296898 bytes) retransmitted
	740242 ack-only packets (646590 delayed)
	153288 window update packets
\end{verbatim}
\end{frame}

\subsection{pf States}
\begin{frame}[fragile]{pf State}
pfctl -ss
\scriptsize
\begin{verbatim}
em0 tcp 80.154.94.48:22 <- 84.191.39.187:60436
       ESTABLISHED:ESTABLISHED
em0 tcp 192.168.0.31:22 (80.154.94.48:10031) <- 80.154.94.10:19890
       ESTABLISHED:ESTABLISHED
em1 tcp 80.154.94.10:19890 -> 192.168.0.31:22
       ESTABLISHED:ESTABLISHED
em0 tcp 192.168.0.31:443 (80.154.94.48:443) <- 193.30.66.53:51727
       CLOSING:ESTABLISHED
\end{verbatim}
\end{frame}

\subsection{Socket}
\begin{frame}[fragile]{Sockets}
netstat -an
\scriptsize
\begin{verbatim}
Active Internet connections (including servers)
Proto   Recv-Q Send-Q  Local Address   Foreign Address  TCP-State
tcp          0      0  10.0.1.37.22    10.0.1.2.30176   ESTABLISHED
tcp          0   1144  10.0.1.37.22    10.0.1.1.27069   ESTABLISHED
tcp          0     44  10.0.1.37.22    10.0.1.2.49002   ESTABLISHED
tcp          0      0  *.22            *.*              LISTEN
Active Internet connections (including servers)
Proto   Recv-Q Send-Q  Local Address   Foreign Address
udp          0      0  10.0.1.37.7040  10.0.1.1.123
udp          0      0  10.0.1.37.161   *.*
udp          0      0  *.*             *.*
\end{verbatim}
\end{frame}

\subsection{tcpdump}
\begin{frame}[fragile]{tcpdump}
tcpdump -ni enc0 -v
\scriptsize
\begin{verbatim}
18:45:13.665393 (unprotected): SPI 0x00006861:
  fdd7:e83e:66bc:100::17 > fdd7:e83e:66bc:100::70:
  10.188.168.17 > 10.188.175.72:
  icmp: echo request
  (id:c52b seq:0) (ttl 255, id 8945, len 1028) (len 1028, hlim 64)
18:45:13.665849 (unprotected): SPI 0x00006862:
  fdd7:e83e:66bc:100::70 > fdd7:e83e:66bc:100::17:
  10.188.175.72 > 10.188.168.17:
  icmp: echo reply
  (id:c52b seq:0) (ttl 253, id 7503, len 1028) (len 1028, hlim 64)
\end{verbatim}
\end{frame}

\section{Implementation}

\subsection{Layer}
\begin{frame}{Layer}
\begin{tikzpicture}
  \draw (-1,0) rectangle +(6,1) node(l1) [midway] {Physical};
  \draw (-1,1) rectangle +(6,1) node(l1) [midway] {Driver};
  \draw (-1,2) rectangle +(6,1) node(l2) [midway] {Ethernet};
  \draw (-1,3) rectangle +(6,1) node(l3) [midway] {Network IP};
  \draw (-1,4) rectangle +(6,1) node(l4) [midway] {TCP/UDP/Raw};
  \draw (-1,5) rectangle +(6,1) node(l5) [midway] {Socket};
  \draw (-1,6) rectangle +(6,1) node(l5) [midway] {Application};
  \draw[thick] (-4,5.5) node(context) {} -- +(5,0) +(7,0) -- +(10.5,0);
  \node [below right] at (context) {Kernel};
  \node [above right] at (context) {User Land};
  \draw[thick] (-4,1) node(hardware) {} -- +(10.5,0);
  \node [below right] at (hardware) {Hardware};
\end{tikzpicture}
\end{frame}

\subsection{Packet Input}
\begin{frame}{Packet Input}
\begin{tikzpicture}
  \draw (0,0)
    node (ni) [right] {network driver interrupt handler} ++(0,.8)
    node (ei) [right] {XXX ifiq\_input XXX ether\_input()} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (rq) [right] {ip interface receive queue} ++(-.5,.8)
    node (ii) [right] {ip\_input()} ++(0,.8)
    node (ps) [right] {inetsw[] internet protocol switch} ++(0,.8)
    node (ti) [right] {tcp\_input()} ++(.1,.6)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4)
    rectangle ++(.4,.4) rectangle ++(.4,-.4) ++(0,.2)
    node (rb) [right,red] {socket receive buffer} ++(-.5,.8)
    node (sr) [right] {soreceive()} ++(0,1.2)
    node (rd)  [right] {read()};

  \path (node cs:name=ni,anchor=west) +(.3,.3) coordinate (nio) {};
  \path (node cs:name=ei,anchor=west) +(.3,-.3) coordinate (eii) {};
  \draw[->] (nio) -- (eii);
  \path (node cs:name=ei,anchor=west) +(.3,.3) coordinate (eio) {};
  \path (node cs:name=rq,anchor=west) +(-.2-5*.4,0) coordinate (rqi) {};
  \draw[->] (eio) -- (rqi);
  \path (node cs:name=rq,anchor=west) +(-.2,0) coordinate (rqo) {};
  \path (node cs:name=ii,anchor=west) +(.3,-.3) coordinate (iii) {};
  \draw[->] (rqo) -- (iii);
  \path (node cs:name=ii,anchor=west) +(.3,.3) coordinate (iio) {};
  \path (node cs:name=ps,anchor=west) +(.3,-.3) coordinate (psi) {};
  \draw[->] (iio) -- (psi);
  \path (node cs:name=ps,anchor=west) +(.3,.3) coordinate (pso) {};
  \path (node cs:name=ti,anchor=west) +(.3,-.3) coordinate (tii) {};
  \draw[->] (pso) -- (tii);
  \path (node cs:name=ti,anchor=west) +(.3+2*.4,.3) coordinate (tio) {};
  \path (node cs:name=rb,anchor=west) +(-.2-3*.4,0) coordinate (rbi) {};
  \draw[->] (tio) -- (rbi);
  \path (node cs:name=rb,anchor=west) +(-.2,0) coordinate (rbo) {};
  \path (node cs:name=sr,anchor=west) +(.3,-.3) coordinate (sri) {};
  \draw[->] (rbo) -- (sri);
  \path (node cs:name=sr,anchor=west) +(.3,.3) coordinate (sro) {};
  \path (node cs:name=rd,anchor=west) +(.3,-.3) coordinate (rdi) {};
  \draw[->] (sro) -- (rdi);

  \draw[thick] (rdi -| 0,0) ++(0,-.3) node (context) {} -- +(10.5,0);
  \node [below right] at (context) {Kernel};
  \node [above right] at (context) {User Land};
\end{tikzpicture}
\end{frame}

\subsection{Data}

\section{Conclusion}

\subsection{Links}
\begin{frame}{Links}
\begin{itemize}
    \item these slides
	{\small \url{https://github.com/bluhm/talk-packetflow}}
\end{itemize}
\end{frame}

\subsection{Questions}
\begin{frame}{Questions}
\begin{center}
\begin{tikzpicture}
\draw [font=\Huge] node {?};
\end{tikzpicture}
\end{center}
\end{frame}

\end{document}
